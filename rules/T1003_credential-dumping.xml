<Sysmon schemaversion="4.30">
  <EventFiltering>
    <RuleGroup name="" groupRelation="or">
			<ProcessCreate onmatch="include">
				<Rule name="technique_id=T1003" name="technique_id=T1003" groupRelation="or">
					<Image condition="contains">gsecdump.exe</Image>
					<Image condition="contains">wce.exe</Image>
					<Image condition="contains">Outflank-Dumpert.exe</Image>
					<Image condition="contains">mimikatz.exe</Image>
					<Image condition="contains">pypykatz.exe</Image>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  	<OriginalFileName condition="contains">procdump</OriginalFileName>
					<CommandLine  condition="is">-ma lsass.exe</CommandLine>
				</Rule>
			</ProcessCreate>
			<!-- Event ID 7 == Image Loaded. -->
			<ImageLoad onmatch="exclude">
			    <Rule name="technique_id=T1003" groupRelation="or">
				  <ImageLoaded condition="is">C:\Windows\System32\samlib.dll</ImageLoaded>
				  <ImageLoaded condition="is">C:\Windows\System32\WinSCard.dll</ImageLoaded>
				  <ImageLoaded condition="is">C:\Windows\System32\cryptdll.dll</ImageLoaded>
				  <ImageLoaded condition="is">C:\Windows\System32\hid.dll</ImageLoaded>
				  <ImageLoaded condition="is">C:\Windows\System32\vaultcli.dll</ImageLoaded>
				  <ImageLoaded condition="is">C:\Windows\System32\wlanapi.dll</ImageLoaded>
				  <ImageLoaded condition="is">C:\Windows\System32\DumpExt.dll</ImageLoaded>
				  <ImageLoaded condition="contains">lsremora64.dll</ImageLoaded>
				  <ImageLoaded condition="contains">lsremora.dll</ImageLoaded>
				  <ImageLoaded condition="contains">wceaux.dll</ImageLoaded>
				</Rule>
			</ImageLoad>
			      <!-- Event ID 8 == CreateRemoteThread. -->
			<CreateRemoteThread onmatch="include">
				<Rule name="technique_id=T1003" groupRelation="or">
				  <TargetImage condition="is">c:\windows\system32\lsass.exe</TargetImage>
				</Rule>
	        </CreateRemoteThread>
			<!-- Event ID 10 == ProcessAccess. -->
			<ProcessAccess onmatch="include">
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <CallTrace condition="contains">dbgcore.dll</CallTrace>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <CallTrace condition="contains">comsvcs.dll</CallTrace>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="contains">wce.exe</TargetImage>
				  <GrantedAccess condition="is">0x1fffff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="or">
				  <TargetImage condition="contains">Outflank-Dumpert.exe</TargetImage>
				  <TargetImage condition="contains">mimikatz.exe</TargetImage>
				  <TargetImage condition="is">C:\Windows\system32\winlogon.exe</TargetImage>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <CallTrace condition="contains">dbghelp.dll</CallTrace>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="contains">procdump.exe</TargetImage>
				  <GrantedAccess condition="is">0x1fffff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="contains">procdump64.exe</TargetImage>
				  <GrantedAccess condition="is">0x1fffff</GrantedAccess>
				</Rule>
		        <Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\csrss.exe</TargetImage>
				  <GrantedAccess condition="is">0x1f1fff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\wininit.exe</TargetImage>
				  <GrantedAccess condition="is">0x1f1fff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\services.exe</TargetImage>
				  <GrantedAccess condition="is">0x1f1fff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage  condition="contains">gsecdump.exe</TargetImage>
				  <GrantedAccess condition="is">0x1fffff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <GrantedAccess condition="is">0x1fffff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <GrantedAccess condition="is">0x1f3fff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <GrantedAccess condition="is">0x1f1fff</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <GrantedAccess condition="is">0x1010</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <GrantedAccess condition="is">0x143a</GrantedAccess>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
				  <TargetImage condition="is">C:\Windows\system32\lsass.exe</TargetImage>
				  <GrantedAccess condition="is">0x147a</GrantedAccess>
				</Rule>
			</ProcessAccess>
      <!-- Event ID 11 == FileCreate. -->
			<FileCreate onmatch="include">
				<Rule name="technique_id=T1003" groupRelation="or">
					<TargetFilename condition="end with">\temp\lsass-comsvcs.dmp</TargetFilename>
					<TargetFilename condition="is">C:\Windows\Temp\wceaux.dll</TargetFilename>
					<TargetFilename condition="contains">procdump64.exe</TargetFilename>
					<TargetFilename condition="end with">lsass_dump.dmp</TargetFilename>
					<TargetFilename condition="is">C:\Windows\Temp\dumpert.dmp</TargetFilename>
					<TargetFilename condition="end with">\AppData\Local\Temp\sam</TargetFilename>
					<TargetFilename condition="end with">\AppData\Local\Temp\system</TargetFilename>
					<TargetFilename condition="end with">\AppData\Local\Temp\security</TargetFilename>
				</Rule>
			</FileCreate>
      <!-- Event ID 12,13,14 == RegObject added/deleted, RegValue Set, RegObject Renamed. -->
			<RegistryEvent onmatch="include">
				<Rule name="technique_id=T1003" groupRelation="or">
					<TargetObject condition="begin with">HKLM\System\CurrentControlSet\Services\WCESERVICE</TargetObject>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
					<Image condition="contains">procdump.exe</Image>
					<TargetObject condition="contains">\ProcDump</TargetObject>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
					<Image condition="contains">procdump64.exe</Image>
					<TargetObject condition="contains">\ProcDump</TargetObject>
				</Rule>
	        </RegistryEvent>
		<!-- Event ID 17,18 == PipeEvent. Log Named pipe created & Named pipe connected -->
			<PipeEvent onmatch="include">
				<Rule name="technique_id=T1003" groupRelation="or">
					<PipeName condition="is">\WCEServicePipe</PipeName>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
					<Image condition="contains">procdump64.exe</Image>
					<PipeName condition="contains">\ProcDump</PipeName>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
					<Image condition="contains">WmiPrvSE.exe</Image>
					<PipeName condition="is">\wkssvc</PipeName>
				</Rule>
				<Rule name="technique_id=T1003" groupRelation="and">
					<Image condition="contains">WmiPrvSE.exe</Image>
					<PipeName condition="is">\srvsvc</PipeName>
				</Rule>
			</PipeEvent>
    </RuleGroup>
  </EventFiltering>
</Sysmon>

